!function(){"use strict";angular.module("shuttle",[]).config(["$routeProvider",function(a){a.when("/shuttle",{templateUrl:"shuttle/mainMenu.html"}).when("/shuttle/planner",{templateUrl:"shuttle/planner.html",controller:"planShuttleController"}).when("/shuttle/planner/:fromPlace/:toPlace/:when/:time/:date",{templateUrl:"shuttle/planner.html",controller:"planShuttleController"}).when("/shuttle/list",{templateUrl:"shuttle/routeList.html",controller:"routeMenuShuttleController"}).when("/shuttle/schedule//:stop",{templateUrl:"shuttle/routeList.html",controller:"routeMenuShuttleController"}).when("/shuttle/locations",{templateUrl:"shuttle/stopList.html",controller:"stopShuttleController"}).when("/shuttle/schedule/:route",{templateUrl:"shuttle/stopList.html",controller:"stopShuttleController"}).when("/shuttle/schedule/:route/:stop",{templateUrl:"shuttle/schedule.html",controller:"scheduleShuttleController"})}]).factory("ShuttleService",["$rootScope",function(a){var b=function(b,c,d,e){var f=function(b){d(b);a.$apply()},g=function(b,c){e(b,c);a.$apply()};"object"==typeof UCSF&&UCSF.Shuttle?UCSF.Shuttle[b](c,f,g):e()};return{times:function(a,c,d){b("times",a,c,d)},stops:function(a,c,d){b("stops",a,c,d)},predictions:function(a,c,d){b("predictions",a,c,d)},routes:function(a,c,d){b("routes",a,c,d)},plan:function(a,c,d){b("plan",a,c,d)}}}]).controller("scheduleShuttleController",["$scope","$routeParams","$filter","$timeout","ShuttleService",function(a,b,c,d,e){a.loading=!0;a.loadError=!1;a.loaded=!1;var f=(new Date).setHours(0,0,0,0),g={routeId:b.route,stopId:b.stop,startTime:f},h=function(b){a.loading=!1;a.loadError=!!b.error;a.loaded=!a.loadError;a.times=[];if(b.times&&b.times.length>0){a.times=b.times;var c=b.times[0];if(c&&c.trip){a.routeShortName=c.trip.route&&c.trip.route.shortName;a.routeId=c.trip.routeId&&c.trip.routeId.id}}a.startTime=f},i=function(){a.loading=!1;a.loadError=!0};a.changeDay=function(b){var c=864e5*b;f=g.startTime+=c;a.loading=!0;a.loaded=!1;e.times(g,h,i)};a.load=function(){e.times(g,h,i);e.stops({routeId:b.route},function(d){var e=c("filter")(d.stops,function(a){return a.id&&a.id.id===b.stop}).pop();a.stopName=e&&e.stopName},function(){})};a.load();var j,k=function(){e.predictions({routeId:b.route,stopId:b.stop},function(b){var c=b.times.slice(0,3);a.predictions={times:c};j=d(k,3e4)},function(){a.predictions={};j=d(k,3e4)})};a.$on("$destroy",function(){j&&d.cancel(j)});k()}]).controller("stopShuttleController",["$scope","$routeParams","ShuttleService",function(a,b,c){a.loading=!0;a.loadError=!1;var d={};b.route&&(d.routeId=b.route);a.load=function(){c.stops(d,function(b){a.loading=!1;a.stops=b.stops||[];if(b.route&&b.route.id){a.routeShortName=b.route.routeShortName||"";a.routeLongName=b.route.routeLongName||"";a.routeId=b.route.id.id}a.loadError=0===a.stops.length},function(){a.loading=!1;a.loadError=!0})};a.load()}]).controller("routeMenuShuttleController",["$scope","$routeParams","ShuttleService",function(a,b,c){a.loading=!0;a.loadError=!1;var d={};b.stop&&(d.stopId=b.stop);a.load=function(){c.routes(d,function(b){a.loading=!1;a.routes=b.routes||{}},function(){a.loading=!1;a.loadError=!0})};a.load()}]).controller("planShuttleController",["$scope","$filter","$location","$routeParams","ShuttleService",function(a,b,c,d,e){a.planLoading=!1;a.planLoaded=!1;a.loadError=!1;a.load=function(){if(d.fromPlace&&d.toPlace&&d.when&&d.time&&d.date){var c={fromPlace:d.fromPlace,toPlace:d.toPlace};a.when=d.when;a.time=d.time;a.date=d.date;if("now"!==d.when){c.arriveBy="arrive"===d.when;c.time=d.time;var f=new Date;f.setDate(f.getDate()+parseInt(d.date,10));c.date=b("date")(f,"M/d/yyyy")}a.planLoading=!0;e.plan(c,function(c){a.planLoading=!1;a.planLoaded=!0;var d=c.plan||{};if(d.itineraries){for(var e,f,g,h=d.date?d.date:Date.now(),i=144e5,j=1,k=d.itineraries.length,l=[],m=0;k>m;m++){g=d.itineraries[m];if(g.duration<72e5&&g.endTime>=h-i&&g.endTime<=h+i){g.index=j;j++;g.startTimeFormatted=b("date")(g.startTime,"shortTime");g.endTimeFormatted=b("date")(g.endTime,"shortTime");g.durationFormatted=Math.round(g.duration/6e4);if(g.hasOwnProperty("legs")){f=g.legs.length;for(var n=0;f>n;n++){e={};e.toName=g.legs[n].to.name;if("BUS"===g.legs[n].mode){e.fromName=g.legs[n].from.name;e.route=g.legs[n].route;e.routeId=g.legs[n].routeId;e.startTime=b("date")(g.legs[n].startTime,"shortTime");e.endTime=b("date")(g.legs[n].endTime,"shortTime");g.legs[n].bus=e}"WALK"===g.legs[n].mode&&(g.legs[n].walk=e)}}}else l.push(m)}m=l.length;for(;m--;)d.itineraries.splice(l[m],1);a.itineraries=d.itineraries}},function(){a.planLoading=!1;a.loadError=!0})}if(!a.time){var g=Date.now(),h=15*Math.floor(parseInt(b("date")(g,"mm"),10)/15);0===h&&(h="00");a.time=b("date")(g,"h:"+h+" a")}a.when=a.when||"now";a.date=a.date||0;a.stopsLoading=!0;a.stopsLoaded=!1;e.stops({},function(c){a.stopsLoading=!1;if(c.stops){a.stops=b("orderBy")(c.stops,"stopName");a.begin=b("filter")(a.stops,function(a){return"Parnassus Campus"===a.stopName})[0];a.end=b("filter")(a.stops,function(a){return"Mission Bay Campus"===a.stopName})[0];if(Modernizr.localstorage){localStorage.shuttleStart&&(a.begin=a.stops[localStorage.shuttleStart]||a.begin);localStorage.shuttleEnd&&(a.end=a.stops[localStorage.shuttleEnd]||a.end)}a.stopsLoaded=!0}else a.loadError=!0},function(){a.stopsLoading=!1;a.loadError=!0})};a.load();a.plan=function(){var b=a.begin.id.agencyId+"_"+a.begin.id.id,d=a.end.id.agencyId+"_"+a.end.id.id;if(Modernizr.localstorage){localStorage.shuttleStart=a.stops.indexOf(a.begin);localStorage.shuttleEnd=a.stops.indexOf(a.end)}c.url("/shuttle/planner/"+[b,d,a.when,a.time,a.date].join("/"))}}])}();